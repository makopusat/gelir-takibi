<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Gelir/Gider Takip Sistemi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      background: #f9f9f9;
      color: #222;
    }
    h2, h3 {
      text-align: center;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    select, input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 12px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      background: #1976d2;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #155a9c;
    }
    button.delete {
      background: #d32f2f;
    }
    button.delete:hover {
      background: #9a2222;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    select[size="8"] {
      height: 180px;
    }
    #filtered-report ul {
      list-style-type: none;
      padding-left: 0;
    }
    #filtered-report ul li {
      background: #e3f2fd;
      margin: 4px 0;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .hidden {
      display: none;
    }
    #message {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: #d32f2f;
    }
  </style>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <h2>Gelir/Gider Takip Sistemi</h2>
  
  <div id="message"></div>

  <!-- Kayıt/Giriş Bölümü -->
  <div id="auth-section" class="section">
    <h3>Kullanıcı Girişi / Kayıt</h3>
    <input type="email" id="email" placeholder="E-posta" />
    <input type="password" id="password" placeholder="Şifre" />
    <button id="registerBtn">Kayıt Ol</button>
    <button id="loginBtn">Giriş Yap</button>
  </div>

  <!-- Ana Uygulama Bölümü -->
  <div id="app-section" class="section hidden">

    <button id="logoutBtn" style="background:#d32f2f; margin-bottom: 15px;">Çıkış Yap</button>

    <form id="transactionForm">
      <label for="type">Tür:</label>
      <select id="type" required>
        <option value="Gelir">Gelir</option>
        <option value="Gider">Gider</option>
      </select>

      <label for="subcategory">Alt Kategori:</label>
      <select id="subcategory" required>
        <!-- Başta boş, kullanıcı ekleyecek -->
      </select>
      <input type="text" id="newSubcategory" placeholder="Yeni Alt Kategori Ekle" />
      <button type="button" id="addSubcategoryBtn">Alt Kategori Ekle</button>

      <label for="amount">Tutar:</label>
      <input type="number" id="amount" step="0.01" min="0" required />

      <label for="description">Açıklama:</label>
      <input type="text" id="description" required />

      <label for="date">Tarih:</label>
      <input type="date" id="date" required />

      <button type="submit" id="addBtn">Ekle</button>
      <button type="button" id="editBtn" class="hidden">Kaydet</button>
    </form>

    <h3>İşlem Listesi</h3>
    <select id="transactionList" size="8" style="width: 100%;"></select>
    <button id="editSelectedBtn">Düzenle</button>
    <button id="deleteSelectedBtn" class="delete">Sil</button>

    <h4>Toplam Gelir: <span id="totalIncome">0</span> TL</h4>
    <h4>Toplam Gider: <span id="totalExpense">0</span> TL</h4>
    <h4>Toplam Kar: <span id="totalProfit">0</span> TL</h4>

    <div class="section" style="margin-top: 30px;">
      <h3>Raporlama</h3>
      <label for="startDate">Başlangıç Tarihi:</label>
      <input type="date" id="startDate" />
      <label for="endDate">Bitiş Tarihi:</label>
      <input type="date" id="endDate" />
      <button id="filterBtn">Raporla</button>
      <button id="printBtn">PDF Olarak Kaydet / Yazdır</button>

      <div id="filtered-report" style="margin-top: 15px;"></div>
    </div>
  </div>

<script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
    authDomain: "gelir-gider-d3dc3.firebaseapp.com",
    projectId: "gelir-gider-d3dc3",
    storageBucket: "gelir-gider-d3dc3.firebasestorage.app",
    messagingSenderId: "791363419549",
    appId: "1:791363419549:web:724a349a5efcd6b7c30374",
    measurementId: "G-B8NKY7SR14"
  };

  // Firebase başlat
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // HTML elementleri
  const messageEl = document.getElementById("message");
  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const registerBtn = document.getElementById("registerBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const typeEl = document.getElementById("type");
  const subcategoryEl = document.getElementById("subcategory");
  const newSubcategoryInput = document.getElementById("newSubcategory");
  const addSubcategoryBtn = document.getElementById("addSubcategoryBtn");

  const amountInput = document.getElementById("amount");
  const descriptionInput = document.getElementById("description");
  const dateInput = document.getElementById("date");

  const transactionForm = document.getElementById("transactionForm");
  const transactionList = document.getElementById("transactionList");
  const editSelectedBtn = document.getElementById("editSelectedBtn");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const addBtn = document.getElementById("addBtn");
  const editBtn = document.getElementById("editBtn");

  const totalIncomeEl = document.getElementById("totalIncome");
  const totalExpenseEl = document.getElementById("totalExpense");
  const totalProfitEl = document.getElementById("totalProfit");

  const startDateEl = document.getElementById("startDate");
  const endDateEl = document.getElementById("endDate");
  const filterBtn = document.getElementById("filterBtn");
  const printBtn = document.getElementById("printBtn");
  const filteredReportEl = document.getElementById("filtered-report");

  // Durum değişkenleri
  let currentUser = null;
  let transactions = [];
  let editIndex = -1;
  let subcategories = new Set();

  // Yardımcı fonksiyon: kullanıcıya mesaj göster
  function showMessage(msg, error = false) {
    messageEl.textContent = msg;
    messageEl.style.color = error ? "#d32f2f" : "green";
    setTimeout(() => { messageEl.textContent = ""; }, 4000);
  }

  // Alt kategorileri yenile (alt kategori select listesi)
  function refreshSubcategories() {
    // Alt kategorileri temizle
    subcategoryEl.innerHTML = "";
    // Küme => array yap ve sırala
    const sortedSubs = Array.from(subcategories).sort();
    for (const sub of sortedSubs) {
      const option = document.createElement("option");
      option.value = sub;
      option.textContent = sub;
      subcategoryEl.appendChild(option);
    }
  }

  // Firebase'den verileri çek
  async function loadTransactions() {
    if (!currentUser) return;
    try {
      const snapshot = await db.collection("users").doc(currentUser.uid).collection("transactions").orderBy("date", "desc").get();
      transactions = snapshot.docs.map(doc => {
        const data = doc.data();
        return { 
          id: doc.id,
          type: data.type,
          subcategory: data.subcategory,
          amount: data.amount,
          description: data.description,
          date: data.date
        };
      });
      refreshTransactionList();
      updateTotals();
      extractSubcategories();
      refreshSubcategories();
    } catch (err) {
      showMessage("Veriler yüklenirken hata oluştu: " + err.message, true);
    }
  }

  // Transaction listesini UI'da yenile
  function refreshTransactionList() {
    transactionList.innerHTML = "";
    transactions.forEach((tx, i) => {
      const option = document.createElement("option");
      option.value = i;
      option.textContent = `${tx.date} - ${tx.type} - ${tx.subcategory} - ${tx.amount.toFixed(2)} TL - ${tx.description}`;
      transactionList.appendChild(option);
    });
  }

  // Toplamları hesapla ve göster
  function updateTotals() {
    const totalIncome = transactions.filter(t => t.type === "Gelir").reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = transactions.filter(t => t.type === "Gider").reduce((sum, t) => sum + t.amount, 0);
    const totalProfit = totalIncome - totalExpense;

    totalIncomeEl.textContent = totalIncome.toFixed(2);
    totalExpenseEl.textContent = totalExpense.toFixed(2);
    totalProfitEl.textContent = totalProfit.toFixed(2);
  }

  // Subcategory kümesini güncelle (yeni eklenenleri veya var olanları topla)
  function extractSubcategories() {
    subcategories.clear();
    transactions.forEach(tx => {
      if (tx.subcategory && tx.subcategory.trim() !== "") {
        subcategories.add(tx.subcategory.trim());
      }
    });
  }

  // Yeni alt kategori ekleme
  addSubcategoryBtn.onclick = () => {
    const newSub = newSubcategoryInput.value.trim();
    if (!newSub) {
      alert("Lütfen eklemek için bir alt kategori adı girin.");
      return;
    }
    if (subcategories.has(newSub)) {
      alert("Bu alt kategori zaten mevcut.");
      return;
    }
    subcategories.add(newSub);
    refreshSubcategories();
    subcategoryEl.value = newSub;
    newSubcategoryInput.value = "";
  };

  // İşlem formunu temizle
  function clearForm() {
    typeEl.value = "Gelir";
    newSubcategoryInput.value = "";
    amountInput.value = "";
    descriptionInput.value = "";
    dateInput.value = new Date().toISOString().substring(0,10);
    editIndex = -1;
    addBtn.classList.remove("hidden");
    editBtn.classList.add("hidden");
  }

  // Yeni işlem ekle
  transactionForm.onsubmit = async (e) => {
    e.preventDefault();
    if (!currentUser) {
      showMessage("Lütfen önce giriş yapın.", true);
      return;
    }

    const type = typeEl.value;
    const subcategory = subcategoryEl.value;
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();
    const date = dateInput.value;

    if (!type || !subcategory || !amount || !description || !date) {
      alert("Lütfen tüm alanları doldurun.");
      return;
    }

    try {
      // Firestore'a kaydet
      const newTx = { type, subcategory, amount, description, date };
      const docRef = await db.collection("users").doc(currentUser.uid).collection("transactions").add(newTx);

      // Local'e ekle
      transactions.unshift({ ...newTx, id: docRef.id });
      extractSubcategories();
      refreshSubcategories();
      refreshTransactionList();
      updateTotals();
      clearForm();
      showMessage("İşlem eklendi.");
    } catch (err) {
      showMessage("Ekleme hatası: " + err.message, true);
    }
  };

  // Düzenleme butonu
  editSelectedBtn.onclick = () => {
    const selectedIndex = transactionList.selectedIndex;
    if (selectedIndex === -1) {
      alert("Lütfen düzenlemek için bir işlem seçin.");
      return;
    }
    editIndex = selectedIndex;
    const tx = transactions[editIndex];

    typeEl.value = tx.type;
    refreshSubcategories();
    subcategoryEl.value = tx.subcategory;
    amountInput.value = tx.amount;
    descriptionInput.value = tx.description;
    dateInput.value = tx.date;

    addBtn.classList.add("hidden");
    editBtn.classList.remove("hidden");
  };

  // Kaydet (düzenle) butonu
  editBtn.onclick = async () => {
    if (editIndex === -1) return;

    const type = typeEl.value;
    const subcategory = subcategoryEl.value;
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();
    const date = dateInput.value;

    if (!type || !subcategory || !amount || !description || !date) {
      alert("Lütfen tüm alanları doldurun.");
      return;
    }

    try {
      const txId = transactions[editIndex].id;
      await db.collection("users").doc(currentUser.uid).collection("transactions").doc(txId).update({
        type, subcategory, amount, description, date
      });

      transactions[editIndex] = { id: txId, type, subcategory, amount, description, date };
      extractSubcategories();
      refreshSubcategories();
      refreshTransactionList();
      updateTotals();
      clearForm();
      showMessage("İşlem güncellendi.");
    } catch (err) {
      showMessage("Güncelleme hatası: " + err.message, true);
    }
  };

  // Silme butonu
  deleteSelectedBtn.onclick = async () => {
    const selectedIndex = transactionList.selectedIndex;
    if (selectedIndex === -1) {
      alert("Lütfen silmek için bir işlem seçin.");
      return;
    }

    if (!confirm("Seçili işlemi silmek istediğinize emin misiniz?")) return;

    try {
      const txId = transactions[selectedIndex].id;
      await db.collection("users").doc(currentUser.uid).collection("transactions").doc(txId).delete();

      transactions.splice(selectedIndex, 1);
      extractSubcategories();
      refreshSubcategories();
      refreshTransactionList();
      updateTotals();
      clearForm();
      showMessage("İşlem silindi.");
    } catch (err) {
      showMessage("Silme hatası: " + err.message, true);
    }
  };

  // Giriş işlemi
  loginBtn.onclick = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      alert("E-posta ve şifre boş olamaz.");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        currentUser = userCredential.user;
        showMessage("Giriş başarılı!");
        emailInput.value = "";
        passwordInput.value = "";
        switchToApp();
      })
      .catch(err => {
        showMessage("Giriş hatası: " + err.message, true);
      });
  };

  // Kayıt işlemi
  registerBtn.onclick = () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      alert("E-posta ve şifre boş olamaz.");
      return;
    }
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        currentUser = userCredential.user;
        showMessage("Kayıt başarılı! Giriş yapılıyor...");
        emailInput.value = "";
        passwordInput.value = "";
        switchToApp();
      })
      .catch(err => {
        showMessage("Kayıt hatası: " + err.message, true);
      });
  };

  // Çıkış işlemi
  logoutBtn.onclick = () => {
    auth.signOut().then(() => {
      currentUser = null;
      switchToAuth();
      showMessage("Çıkış yapıldı.");
    });
  };

  // Oturum açılmışsa uygulamaya geç
  function switchToApp() {
    authSection.classList.add("hidden");
    appSection.classList.remove("hidden");
    loadTransactions();
    clearForm();
  }

  // Oturum yoksa giriş ekranına geç
  function switchToAuth() {
    authSection.classList.remove("hidden");
    appSection.classList.add("hidden");
  }

  // Sayfa yüklendiğinde oturum kontrolü
  auth.onAuthStateChanged(user => {
    if (user) {
      currentUser = user;
      switchToApp();
    } else {
      currentUser = null;
      switchToAuth();
    }
  });

  // Tarihe göre filtreleme ve rapor oluşturma
  function updateFilteredReport() {
    const startDate = startDateEl.value ? new Date(startDateEl.value) : null;
    const endDate = endDateEl.value ? new Date(endDateEl.value) : null;

    const filtered = transactions.filter(tx => {
      const txDate = new Date(tx.date);
      if (startDate && txDate < startDate) return false;
      if (endDate && txDate > endDate) return false;
      return true;
    });

    // Alt kategori bazında grupla
    const grouped = { Gelir: {}, Gider: {} };
    filtered.forEach(tx => {
      if (!grouped[tx.type][tx.subcategory]) {
        grouped[tx.type][tx.subcategory] = 0;
      }
      grouped[tx.type][tx.subcategory] += tx.amount;
    });

    // Toplamları hesapla
    const totalIncome = filtered
      .filter(t => t.type === "Gelir")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = filtered
      .filter(t => t.type === "Gider")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalProfit = totalIncome - totalExpense;

    filteredReportEl.innerHTML = "";

    // Gelir alt kategorileri
    const gelirHeader = document.createElement("h4");
    gelirHeader.textContent = "Gelir Alt Kategorileri";
    filteredReportEl.appendChild(gelirHeader);

    const gelirList = document.createElement("ul");
    for (const [subcategory, amount] of Object.entries(grouped.Gelir)) {
      const li = document.createElement("li");
      li.textContent = `${subcategory}: ${amount.toFixed(2)} TL`;
      gelirList.appendChild(li);
    }
    if (gelirList.childElementCount === 0) {
      const li = document.createElement("li");
      li.textContent = "Veri yok";
      gelirList.appendChild(li);
    }
    filteredReportEl.appendChild(gelirList);

    // Gider alt kategorileri
    const giderHeader = document.createElement("h4");
    giderHeader.textContent = "Gider Alt Kategorileri";
    filteredReportEl.appendChild(giderHeader);

    const giderList = document.createElement("ul");
    for (const [subcategory, amount] of Object.entries(grouped.Gider)) {
      const li = document.createElement("li");
      li.textContent = `${subcategory}: ${amount.toFixed(2)} TL`;
      giderList.appendChild(li);
    }
    if (giderList.childElementCount === 0) {
      const li = document.createElement("li");
      li.textContent = "Veri yok";
      giderList.appendChild(li);
    }
    filteredReportEl.appendChild(giderList);

    // Toplamları göster
    const totals = document.createElement("div");
    totals.innerHTML = `
      <h4>Toplam Gelir: ${totalIncome.toFixed(2)} TL</h4>
      <h4>Toplam Gider: ${totalExpense.toFixed(2)} TL</h4>
      <h4>Net Kar/Zarar: ${totalProfit.toFixed(2)} TL</h4>
    `;
    filteredReportEl.appendChild(totals);
  }

  filterBtn.onclick = updateFilteredReport;

  // Yazdırma fonksiyonu
  printBtn.onclick = () => {
    const printContents = filteredReportEl.innerHTML;
    const originalContents = document.body.innerHTML;

    document.body.innerHTML = `<h2>Gelir/Gider Raporu</h2>${printContents}`;
    window.print();
    document.body.innerHTML = originalContents;
    location.reload();
  };

});
</script>

</body>
</html>
