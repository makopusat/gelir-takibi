<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Gelir Gider Uygulaması</title>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
      authDomain: "gelir-gider-d3dc3.firebaseapp.com",
      projectId: "gelir-gider-d3dc3",
      storageBucket: "gelir-gider-d3dc3.appspot.com",
      messagingSenderId: "791363419549",
      appId: "1:791363419549:web:724a349a5efcd6b7c30374",
      measurementId: "G-B8NKY7SR14"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    window.login = function () {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      signInWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          console.log("Giriş başarılı:", userCredential.user.email);
          document.getElementById("loginDiv").style.display = "none";
          const appDiv = document.getElementById("appDiv");
          appDiv.style.display = "block";
          appDiv.style.visibility = "visible";
          appDiv.style.opacity = "1";
          document.getElementById("welcome").innerText = "Hoş geldin, " + email;
          loadReport();
        })
        .catch(error => {
          console.error("Giriş Hatası:", error);
          alert("Giriş Hatası: " + error.message);
        });
    }

    window.register = function () {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;

      createUserWithEmailAndPassword(auth, email, password)
        .then(userCredential => {
          console.log("Kayıt başarılı:", userCredential.user.email);
          alert("Kayıt başarılı! Şimdi giriş yapabilirsiniz.");
        })
        .catch(error => {
          console.error("Kayıt Hatası:", error);
          alert("Kayıt Hatası: " + error.message);
        });
    }

    window.logout = function () {
      signOut(auth).then(() => {
        document.getElementById("loginDiv").style.display = "block";
        const appDiv = document.getElementById("appDiv");
        appDiv.style.display = "none";
        appDiv.style.visibility = "hidden";
        appDiv.style.opacity = "0";
        document.getElementById("welcome").innerText = "";
        document.getElementById("report").innerText = "";
      });
    }

    window.addTransaction = async function () {
      const user = auth.currentUser;
      if (!user) {
        alert("Lütfen önce giriş yapın.");
        return;
      }
      const type = document.getElementById("type").value;
      const amount = parseFloat(document.getElementById("amount").value);
      if (isNaN(amount) || amount <= 0) {
        alert("Lütfen geçerli bir tutar girin.");
        return;
      }
      const description = document.getElementById("description").value || "";

      try {
        await addDoc(collection(db, "transactions"), {
          userId: user.uid,
          type,
          amount,
          description,
          createdAt: new Date()
        });
        alert("Kayıt eklendi.");
        document.getElementById("amount").value = "";
        document.getElementById("description").value = "";
        loadReport();
      } catch (e) {
        console.error("Kayıt ekleme hatası:", e);
        alert("Kayıt eklenirken hata oluştu.");
      }
    }

    async function loadReport() {
      const user = auth.currentUser;
      if (!user) return;

      try {
        const q = query(collection(db, "transactions"), where("userId", "==", user.uid));
        const querySnapshot = await getDocs(q);

        let totalIncome = 0;
        let totalExpense = 0;

        querySnapshot.forEach(doc => {
          const data = doc.data();
          if (data.type === "Gelir") totalIncome += data.amount;
          else totalExpense += data.amount;
        });

        document.getElementById("report").innerText =
          `Toplam Gelir: ${totalIncome.toFixed(2)} TL\n` +
          `Toplam Gider: ${totalExpense.toFixed(2)} TL\n` +
          `Net: ${(totalIncome - totalExpense).toFixed(2)} TL`;
      } catch (e) {
        console.error("Rapor yükleme hatası:", e);
        document.getElementById("report").innerText = "Rapor yüklenirken hata oluştu.";
      }
    }

    onAuthStateChanged(auth, user => {
      if (user) {
        document.getElementById("loginDiv").style.display = "none";
        const appDiv = document.getElementById("appDiv");
        appDiv.style.display = "block";
        appDiv.style.visibility = "visible";
        appDiv.style.opacity = "1";
        document.getElementById("welcome").innerText = "Hoş geldin, " + user.email;
        loadReport();
      } else {
        document.getElementById("loginDiv").style.display = "block";
        const appDiv = document.getElementById("appDiv");
        appDiv.style.display = "none";
        appDiv.style.visibility = "hidden";
        appDiv.style.opacity = "0";
        document.getElementById("welcome").innerText = "";
        document.getElementById("report").innerText = "";
      }
    });
  </script>
</head>
<body>
  <h1>Gelir Gider Uygulaması</h1>

  <div id="loginDiv">
    <input type="email" id="email" placeholder="Email" /><br />
    <input type="password" id="password" placeholder="Şifre" /><br />
    <button onclick="login()">Giriş Yap</button>
    <button onclick="register()">Kayıt Ol</button>
  </div>

  <div id="appDiv" style="display:none; visibility:hidden; opacity:0; transition: opacity 0.3s ease;">
    <p id="welcome"></p>
    <button onclick="logout()">Çıkış Yap</button>

    <h3>Yeni Gelir/Gider Ekle</h3>
    <select id="type">
      <option value="Gelir">Gelir</option>
      <option value="Gider">Gider</option>
    </select><br />
    <input type="number" id="amount" placeholder="Tutar" /><br />
    <input type="text" id="description" placeholder="Açıklama" /><br />
    <button onclick="addTransaction()">Ekle</button>

    <h3>Rapor</h3>
    <pre id="report"></pre>
  </div>
</body>
</html>
