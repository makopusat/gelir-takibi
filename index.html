<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gelir Gider Takip - Firebase Auth + Kategori + Rapor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  header { background: #4a90e2; color: white; padding: 1rem; text-align: center; }
  main { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc;}
  h2 { margin-top: 0; }
  label { display: block; margin: 10px 0 5px; font-weight: bold; }
  input[type=text], input[type=number], input[type=date], select {
    width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;
  }
  button {
    width: 100%; padding: 12px; margin: 15px 0;
    background-color: #4a90e2; border: none; border-radius: 6px;
    color: white; font-weight: bold; font-size: 1.1rem;
    cursor: pointer;
  }
  button:hover { background-color: #357abd; }
  .hidden { display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #4a90e2; color: white; }
  #totals { margin-top: 15px; font-weight: bold; font-size: 1.1rem; }
  .message { padding: 10px; background-color: #d4edda; color: #155724; margin-bottom: 15px; border-radius: 5px; display:none; }
  .error { background-color: #f8d7da; color: #721c24; }
</style>

<!-- Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
    authDomain: "gelir-gider-d3dc3.firebaseapp.com",
    projectId: "gelir-gider-d3dc3",
    storageBucket: "gelir-gider-d3dc3.appspot.com",
    messagingSenderId: "791363419549",
    appId: "1:791363419549:web:724a349a5efcd6b7c30374"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Elements
  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const messageDiv = document.getElementById('message');
  const errorDiv = document.getElementById('errorMessage');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogout = document.getElementById('btnLogout');

  // Gelir-Gider form elemanları
  const typeSelect = document.getElementById('type');
  const categorySelect = document.getElementById('categorySelect');
  const addCategoryInput = document.getElementById('addCategoryInput');
  const addCategoryBtn = document.getElementById('addCategoryBtn');
  const subcategoryInput = document.getElementById('subcategory');
  const amountInput = document.getElementById('amount');
  const descriptionInput = document.getElementById('description');
  const dateInput = document.getElementById('date');
  const addEntryBtn = document.getElementById('addEntryBtn');

  const entriesTable = document.getElementById('entriesTable');
  const entriesTbody = document.getElementById('entriesTbody');
  const totalsDiv = document.getElementById('totals');

  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const filterBtn = document.getElementById('filterBtn');

  // Kategoriler
  let categories = ['Maaş', 'Kira', 'Market', 'Elektrik'];
  let selectedCategories = new Set();

  // Gelir-Gider kayıtları
  let entries = [];

  // --- Yardımcı fonksiyonlar ---

  function showMessage(text) {
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
  }

  function showError(text) {
    errorDiv.textContent = text;
    errorDiv.style.display = 'block';
    messageDiv.style.display = 'none';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
  }

  // Kategori dropdown’ı yenile
  function loadCategories() {
    categorySelect.innerHTML = '<option value="">Seçiniz...</option>';
    categories.forEach(cat => {
      if (!selectedCategories.has(cat)) {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      }
    });
  }

  // Seçilen kategoriyi dropdown’dan çıkar
  function addSelectedCategory(cat) {
    selectedCategories.add(cat);
    loadCategories();
  }

  // Kategoriyi silme ve dropdown’a geri ekleme
  function removeSelectedCategory(cat) {
    selectedCategories.delete(cat);
    loadCategories();
  }

  // Girilen tarihleri YYYY-MM-DD formatında karşılaştırma
  function isDateBetween(date, start, end) {
    if (!start && !end) return true;
    const d = new Date(date);
    if (start && d < new Date(start)) return false;
    if (end && d > new Date(end)) return false;
    return true;
  }

  // Raporlama fonksiyonu (kategori+alt kategori+tip bazında toplayarak)
  function displayEntries(filteredEntries) {
    if (filteredEntries.length === 0) {
      entriesTable.style.display = 'none';
      totalsDiv.textContent = 'Kayıt bulunamadı.';
      return;
    }

    // Gruplama için nesne
    const grouped = {};

    filteredEntries.forEach(entry => {
      const key = `${entry.type}|${entry.category}|${entry.subcategory || '-'}`;

      if (!grouped[key]) {
        grouped[key] = {
          type: entry.type,
          category: entry.category,
          subcategory: entry.subcategory || '-',
          amount: 0
        };
      }
      grouped[key].amount += entry.amount;
    });

    entriesTable.style.display = 'table';
    entriesTbody.innerHTML = '';

    let totalIncome = 0;
    let totalExpense = 0;

    Object.values(grouped).forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.type === 'gelir' ? 'Gelir' : 'Gider'}</td>
        <td>${entry.category}</td>
        <td>${entry.subcategory}</td>
        <td>${entry.amount.toFixed(2)}</td>
      `;
      entriesTbody.appendChild(tr);

      if (entry.type === 'gelir') totalIncome += entry.amount;
      else totalExpense += entry.amount;
    });

    const net = totalIncome - totalExpense;
    totalsDiv.textContent = `Toplam Gelir: ₺${totalIncome.toFixed(2)} | Toplam Gider: ₺${totalExpense.toFixed(2)} | Net Kar/Zarar: ₺${net.toFixed(2)}`;
  }

  // --- Event Listeners ---

  // Firebase Authentication state değişimi
  onAuthStateChanged(auth, user => {
    if (user) {
      loginSection.style.display = 'none';
      appSection.style.display = 'block';
      loadCategories();
      displayEntries(entries);
      resetForm();
    } else {
      loginSection.style.display = 'block';
      appSection.style.display = 'none';
    }
  });

  // Giriş yap
  btnLogin.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) {
      showError('Lütfen e-posta ve şifre giriniz.');
      return;
    }
    signInWithEmailAndPassword(auth, email, pass)
      .then(() => {
        showMessage('Başarıyla giriş yapıldı.');
        emailInput.value = '';
        passwordInput.value = '';
      })
      .catch(err => showError('Giriş başarısız: ' + err.message));
  });

  // Kayıt ol
  btnRegister.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value.trim();
    if (!email || !pass) {
      showError('Lütfen e-posta ve şifre giriniz.');
      return;
    }
    createUserWithEmailAndPassword(auth, email, pass)
      .then(() => {
        showMessage('Kayıt başarılı, giriş yapabilirsiniz.');
        emailInput.value = '';
        passwordInput.value = '';
      })
      .catch(err => showError('Kayıt başarısız: ' + err.message));
  });

  // Çıkış yap
  btnLogout.addEventListener('click', () => {
    signOut(auth).then(() => {
      showMessage('Çıkış yapıldı.');
    });
  });

  // Yeni kategori ekle (manuel)
  addCategoryBtn.addEventListener('click', () => {
    const newCat = addCategoryInput.value.trim();
    if (!newCat) {
      showError('Kategori boş olamaz.');
      return;
    }
    if (!categories.includes(newCat)) {
      categories.push(newCat);
      loadCategories();
      addCategoryInput.value = '';
      showMessage(`Kategori "${newCat}" eklendi.`);
    } else {
      showError('Bu kategori zaten mevcut.');
    }
  });

  // Kategori seçildiğinde seçilen kategoriyi set’e ekle (seçilen kategori dropdown’dan çıkar)
  categorySelect.addEventListener('change', () => {
    const selected = categorySelect.value;
    if (selected) {
      addSelectedCategory(selected);
    }
  });

  // Gelir/Gider ekle
  addEntryBtn.addEventListener('click', () => {
    const type = typeSelect.value;
    const category = categorySelect.value;
    const subcategory = subcategoryInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();
    const date = dateInput.value;

    if (!type || !category) {
      showError('Lütfen Gelir veya Gider ve Kategori seçiniz.');
      return;
    }
    if (isNaN(amount) || amount <= 0) {
      showError('Lütfen geçerli bir tutar giriniz.');
      return;
    }
    if (!date) {
      showError('Lütfen tarih seçiniz.');
      return;
    }

    entries.push({ type, category, subcategory, amount, description, date });
    addSelectedCategory(category);
    showMessage('Girdi başarıyla eklendi.');

    displayEntries(entries);
    resetForm();
  });

  // Filtrele butonu
  filterBtn.addEventListener('click', () => {
    const start = startDateInput.value;
    const end = endDateInput.value;

    const filtered = entries.filter(e => isDateBetween(e.date, start, end));
    displayEntries(filtered);
  });

  // Formu sıfırla
  function resetForm() {
    typeSelect.value = '';
    // Kategori seçimi sıfırlanmayacak, çünkü seçilen kategori dropdown’dan çıkarılıyor.
    subcategoryInput.value = '';
    amountInput.value = '';
    descriptionInput.value = '';
    dateInput.value = '';
  }

</script>
</head>
<body>

<header>
  <h1>Gelir Gider Takip Sistemi</h1>
</header>

<section id="loginSection">
  <main>
    <h2>Giriş Yap / Kayıt Ol</h2>
    <label for="email">E-posta:</label>
    <input id="email" type="email" placeholder="E-posta giriniz" />

    <label for="password">Şifre:</label>
    <input id="password" type="password" placeholder="Şifre giriniz" />

    <button id="btnLogin">Giriş Yap</button>
    <button id="btnRegister">Kayıt Ol</button>

    <div id="message" class="message"></div>
    <div id="errorMessage" class="message error"></div>
  </main>
</section>

<section id="appSection" class="hidden">
  <main>
    <button id="btnLogout" style="background-color:#e74c3c; margin-bottom: 20px;">Çıkış Yap</button>

    <h2>Gelir / Gider Ekle</h2>
    <label for="type">Tür:</label>
    <select id="type">
      <option value="">Seçiniz...</option>
      <option value="gelir">Gelir</option>
      <option value="gider">Gider</option>
    </select>

    <label for="categorySelect">Kategori (Seçiniz veya yeni ekleyin):</label>
    <select id="categorySelect">
      <!-- Kategoriler buraya yüklenecek -->
    </select>

    <input id="addCategoryInput" type="text" placeholder="Yeni kategori ekle" />
    <button id="addCategoryBtn" type="button">Kategori Ekle</button>

    <label for="subcategory">Alt Kategori (manuel yazınız):</label>
    <input id="subcategory" type="text" placeholder="Alt kategori giriniz" />

    <label for="amount">Tutar:</label>
    <input id="amount" type="number" step="0.01" placeholder="Tutar giriniz" />

    <label for="description">Açıklama (opsiyonel):</label>
    <input id="description" type="text" placeholder="Açıklama giriniz" />

    <label for="date">Tarih:</label>
    <input id="date" type="date" />

    <button id="addEntryBtn" type="button">Gelir/Gider Ekle</button>

    <h2>Raporlama</h2>
    <label for="startDate">Başlangıç Tarihi:</label>
    <input id="startDate" type="date" />

    <label for="endDate">Bitiş Tarihi:</label>
    <input id="endDate" type="date" />

    <button id="filterBtn" type="button">Filtrele</button>

    <table id="entriesTable" style="display:none;">
      <thead>
        <tr>
          <th>Tür</th>
          <th>Kategori</th>
          <th>Alt Kategori</th>
          <th>Tutar (₺)</th>
        </tr>
      </thead>
      <tbody id="entriesTbody"></tbody>
    </table>

    <div id="totals"></div>

    <div id="message" class="message"></div>
    <div id="errorMessage" class="message error"></div>
  </main>
</section>

</body>
</html>
