<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gelir Gider Takip - PDF ve Rapor</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  header { background: #4a90e2; color: white; padding: 1rem; text-align: center; }
  main { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc;}
  h2 { margin-top: 0; }
  label { display: block; margin: 10px 0 5px; font-weight: bold; }
  input[type=text], input[type=number], input[type=date], select {
    width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;
  }
  button {
    width: 100%; padding: 12px; margin: 15px 0;
    background-color: #4a90e2; border: none; border-radius: 6px;
    color: white; font-weight: bold; font-size: 1.1rem;
    cursor: pointer;
  }
  button:hover { background-color: #357abd; }
  .hidden { display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #4a90e2; color: white; }
  #totals { margin-top: 15px; font-weight: bold; font-size: 1.1rem; }
  .message { padding: 10px; background-color: #d4edda; color: #155724; margin-bottom: 15px; border-radius: 5px; display:none; }
  .error { background-color: #f8d7da; color: #721c24; }
</style>
</head>
<body>

<header>
  <h1>Gelir Gider Takip Sistemi</h1>
</header>

<section id="appSection">
  <h2>Gelir/Gider Kaydı Ekle</h2>
  <label for="type">Tür:</label>
  <select id="type">
    <option value="">Seçiniz...</option>
    <option value="gelir">Gelir</option>
    <option value="gider">Gider</option>
  </select>

  <label for="categorySelect">Kategori Seç:</label>
  <select id="categorySelect"></select>

  <label for="addCategoryInput">Yeni Kategori Ekle (manuel):</label>
  <input type="text" id="addCategoryInput" placeholder="Yeni kategori adı" />
  <button id="addCategoryBtn">Kategori Ekle</button>

  <label for="subcategorySelect">Alt Kategori Seç:</label>
  <select id="subcategorySelect"></select>

  <label for="addSubcategoryInput">Yeni Alt Kategori Ekle (manuel, seçili kategoriye):</label>
  <input type="text" id="addSubcategoryInput" placeholder="Yeni alt kategori adı" />
  <button id="addSubcategoryBtn">Alt Kategori Ekle</button>

  <label for="amount">Tutar (₺):</label>
  <input type="number" id="amount" min="0.01" step="0.01" />

  <label for="description">Açıklama (opsiyonel):</label>
  <input type="text" id="description" />

  <label for="date">Tarih:</label>
  <input type="date" id="date" />

  <button id="addEntryBtn">Kayıt Ekle</button>

  <h2>Raporlama</h2>
  <label for="startDate">Başlangıç Tarihi:</label>
  <input type="date" id="startDate" />
  <label for="endDate">Bitiş Tarihi:</label>
  <input type="date" id="endDate" />
  <button id="filterBtn">Filtrele</button>
  <button id="exportPdfBtn" style="background-color:#28a745; margin-top: 10px;">PDF Olarak İndir</button>

  <table id="entriesTable" style="display:none;">
    <thead>
      <tr>
        <th>Tür</th>
        <th>Kategori</th>
        <th>Alt Kategori</th>
        <th>Tutar (₺)</th>
      </tr>
    </thead>
    <tbody id="entriesTbody"></tbody>
  </table>
  <div id="totals"></div>

  <div id="message" class="message"></div>
  <div id="errorMessage" class="message error"></div>
</section>

<script>
  // Başlangıç veri yapıları ve DOM referansları
  let categories = ['Maaş', 'Kira', 'Market', 'Elektrik'];
  let subcategoriesByCategory = {
    'Maaş': ['Bonus', 'Aylık'],
    'Kira': ['Ev', 'İşyeri'],
    'Market': [],
    'Elektrik': []
  };
  let entries = [];

  const typeSelect = document.getElementById('type');
  const categorySelect = document.getElementById('categorySelect');
  const addCategoryInput = document.getElementById('addCategoryInput');
  const addCategoryBtn = document.getElementById('addCategoryBtn');

  const subcategorySelect = document.getElementById('subcategorySelect');
  const addSubcategoryInput = document.getElementById('addSubcategoryInput');
  const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');

  const amountInput = document.getElementById('amount');
  const descriptionInput = document.getElementById('description');
  const dateInput = document.getElementById('date');
  const addEntryBtn = document.getElementById('addEntryBtn');

  const entriesTable = document.getElementById('entriesTable');
  const entriesTbody = document.getElementById('entriesTbody');
  const totalsDiv = document.getElementById('totals');

  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const filterBtn = document.getElementById('filterBtn');
  const exportPdfBtn = document.getElementById('exportPdfBtn');

  const messageDiv = document.getElementById('message');
  const errorDiv = document.getElementById('errorMessage');

  function showMessage(text) {
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
  }

  function showError(text) {
    errorDiv.textContent = text;
    errorDiv.style.display = 'block';
    messageDiv.style.display = 'none';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
  }

  function loadCategories() {
    categorySelect.innerHTML = '<option value="">Seçiniz...</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categorySelect.appendChild(opt);
    });
  }

  function loadSubcategories(cat) {
    subcategorySelect.innerHTML = '<option value="">(Alt kategori seçiniz veya yeni ekleyin)</option>';
    if (!cat || !subcategoriesByCategory[cat]) return;
    subcategoriesByCategory[cat].forEach(sub => {
      const opt = document.createElement('option');
      opt.value = sub;
      opt.textContent = sub;
      subcategorySelect.appendChild(opt);
    });
  }

  categorySelect.addEventListener('change', () => {
    loadSubcategories(categorySelect.value);
  });

  addCategoryBtn.addEventListener('click', () => {
    const newCat = addCategoryInput.value.trim();
    if (!newCat) {
      showError('Kategori adı boş olamaz!');
      return;
    }
    if (categories.includes(newCat)) {
      showError('Bu kategori zaten mevcut!');
      return;
    }
    categories.push(newCat);
    subcategoriesByCategory[newCat] = [];
    loadCategories();
    addCategoryInput.value = '';
    showMessage('Kategori eklendi.');
  });

  addSubcategoryBtn.addEventListener('click', () => {
    const newSub = addSubcategoryInput.value.trim();
    const selectedCat = categorySelect.value;
    if (!selectedCat) {
      showError('Lütfen önce kategori seçin!');
      return;
    }
    if (!newSub) {
      showError('Alt kategori boş olamaz!');
      return;
    }
    if (!subcategoriesByCategory[selectedCat]) {
      subcategoriesByCategory[selectedCat] = [];
    }
    if (subcategoriesByCategory[selectedCat].includes(newSub)) {
      showError('Bu alt kategori zaten mevcut!');
      return;
    }
    subcategoriesByCategory[selectedCat].push(newSub);
    loadSubcategories(selectedCat);
    addSubcategoryInput.value = '';
    showMessage('Alt kategori eklendi.');
  });

  addEntryBtn.addEventListener('click', () => {
    const type = typeSelect.value;
    const category = categorySelect.value;
    const subcategory = subcategorySelect.value || '';
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();
    const date = dateInput.value;

    if (!type) {
      showError('Lütfen gelir veya gider seçin.');
      return;
    }
    if (!category) {
      showError('Lütfen kategori seçin.');
      return;
    }
    if (!amount || amount <= 0) {
      showError('Lütfen geçerli bir tutar girin.');
      return;
    }
    if (!date) {
      showError('Lütfen tarih seçin.');
      return;
    }

    entries.push({ type, category, subcategory, amount, description, date });
    showMessage('Kayıt eklendi.');

    amountInput.value = '';
    descriptionInput.value = '';
    dateInput.value = new Date().toISOString().substring(0,10); // bugünün tarihi

    applyFilter();
  });

  function isDateBetween(date, start, end) {
    if (!date) return false;
    const d = new Date(date);
    if (start && d < new Date(start)) return false;
    if (end && d > new Date(end)) return false;
    return true;
  }

  function displayEntries(entriesToShow) {
    entriesTbody.innerHTML = '';
    if (entriesToShow.length === 0) {
      entriesTable.style.display = 'none';
      totalsDiv.textContent = 'Gösterilecek kayıt bulunamadı.';
      return;
    }

    entriesTable.style.display = 'table';

    let totalIncome = 0;
    let totalExpense = 0;

    entriesToShow.forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.type}</td>
        <td>${entry.category}</td>
        <td>${entry.subcategory || '-'}</td>
        <td>${entry.amount.toFixed(2)}</td>
      `;
      entriesTbody.appendChild(tr);

      if (entry.type === 'gelir') totalIncome += entry.amount;
      else totalExpense += entry.amount;
    });

    totalsDiv.textContent = `Toplam Gelir: ${totalIncome.toFixed(2)} ₺, Toplam Gider: ${totalExpense.toFixed(2)} ₺, Net Kar/Zarar: ${(totalIncome - totalExpense).toFixed(2)} ₺`;
  }

  function applyFilter() {
    const start = startDateInput.value;
    const end = endDateInput.value;
    const filtered = entries.filter(e => isDateBetween(e.date, start, end));
    displayEntries(filtered);
  }

  filterBtn.addEventListener('click', applyFilter);

  // PDF indir butonu fonksiyonu için jsPDF kullanacağız
  // jsPDF CDN eklemediğimiz için buraya basit bir dışa aktarma fonksiyonu yazalım:

  exportPdfBtn.addEventListener('click', () => {
    if (entries.length === 0) {
      showError('PDF oluşturmak için kayıt yok.');
      return;
    }
    let content = `Gelir Gider Raporu\n\n`;
    content += `Tür\tKategori\tAlt Kategori\tTutar (₺)\n`;

    const start = startDateInput.value;
    const end = endDateInput.value;
    const filtered = entries.filter(e => isDateBetween(e.date, start, end));

    filtered.forEach(e => {
      content += `${e.type}\t${e.category}\t${e.subcategory || '-'}\t${e.amount.toFixed(2)}\n`;
    });

    let totalIncome = 0;
    let totalExpense = 0;
    filtered.forEach(e => {
      if (e.type === 'gelir') totalIncome += e.amount;
      else totalExpense += e.amount;
    });

    content += `\nToplam Gelir: ${totalIncome.toFixed(2)} ₺\n`;
    content += `Toplam Gider: ${totalExpense.toFixed(2)} ₺\n`;
    content += `Net Kar/Zarar: ${(totalIncome - totalExpense).toFixed(2)} ₺\n`;

    // Basit olarak TXT formatında indirme yapacağız:
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'gelir-gider-raporu.txt';
    link.click();
    URL.revokeObjectURL(link.href);
  });

  // Sayfa yüklendiğinde
  window.onload = () => {
    loadCategories();
    categorySelect.dispatchEvent(new Event('change'));
    dateInput.value = new Date().toISOString().substring(0,10);
    applyFilter();
  };
</script>

</body>
</html>
