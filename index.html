<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gelir Gider Takip</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  select, input { padding: 5px; margin-top: 5px; width: 200px; }
  button { margin-top: 15px; padding: 10px 20px; cursor: pointer; }
  table { width: 100%; border-collapse: collapse; margin-top: 15px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #eee; }
  #totals { margin-top: 20px; font-weight: bold; }
</style>
</head>
<body>

<h1>Gelir Gider Takip Sistemi</h1>

<!-- Giriş/Kayıt kısmı burada olmalı ama buraya dahil etmedim, sadece giriş yapıldığı varsayımıyla devam -->

<section>
  <h2>Gelir/Gider Ekle</h2>
  <label>Tür:
    <select id="typeSelect">
      <option value="">Seçiniz</option>
      <option value="gelir">Gelir</option>
      <option value="gider">Gider</option>
    </select>
  </label>
  <label>Kategori:
    <input type="text" id="categoryInput" placeholder="Kategori giriniz (manuel)" />
  </label>
  <label>Tutar:
    <input type="number" id="amountInput" min="0" step="0.01" />
  </label>
  <label>Tarih:
    <input type="date" id="dateInput" />
  </label>
  <button id="addEntryBtn">Ekle</button>
</section>

<section>
  <h2>Rapor Filtrele</h2>
  <label>Başlangıç Tarihi:
    <input type="date" id="startDateInput" />
  </label>
  <label>Bitiş Tarihi:
    <input type="date" id="endDateInput" />
  </label>
  <button id="filterBtn">Filtrele</button>
  <button id="exportPdfBtn">PDF İndir</button>
</section>

<section>
  <h2>Rapor</h2>
  <table id="reportTable" style="display:none;">
    <thead>
      <tr>
        <th>Tür</th>
        <th>Kategori</th>
        <th>Tutar (₺)</th>
      </tr>
    </thead>
    <tbody id="reportBody"></tbody>
  </table>
  <div id="totals"></div>
</section>

<script>
  const { jsPDF } = window.jspdf;

  let entries = [];

  const typeSelect = document.getElementById('typeSelect');
  const categoryInput = document.getElementById('categoryInput');
  const amountInput = document.getElementById('amountInput');
  const dateInput = document.getElementById('dateInput');
  const addEntryBtn = document.getElementById('addEntryBtn');

  const startDateInput = document.getElementById('startDateInput');
  const endDateInput = document.getElementById('endDateInput');
  const filterBtn = document.getElementById('filterBtn');

  const reportTable = document.getElementById('reportTable');
  const reportBody = document.getElementById('reportBody');
  const totalsDiv = document.getElementById('totals');

  const exportPdfBtn = document.getElementById('exportPdfBtn');

  // Tarih varsayılan bugün
  dateInput.value = new Date().toISOString().slice(0,10);

  addEntryBtn.addEventListener('click', () => {
    const type = typeSelect.value;
    const category = categoryInput.value.trim();
    const amount = parseFloat(amountInput.value);
    const date = dateInput.value;

    if(!type) return alert('Lütfen gelir veya gider seçin.');
    if(!category) return alert('Kategori boş olamaz.');
    if(!amount || amount <= 0) return alert('Geçerli tutar girin.');
    if(!date) return alert('Tarih seçin.');

    entries.push({ type, category, amount, date });

    alert('Kayıt eklendi.');

    // Temizle
    categoryInput.value = '';
    amountInput.value = '';
    dateInput.value = new Date().toISOString().slice(0,10);

    renderReport(entries);
  });

  filterBtn.addEventListener('click', () => {
    const start = startDateInput.value;
    const end = endDateInput.value;

    const filtered = entries.filter(e => {
      if(start && e.date < start) return false;
      if(end && e.date > end) return false;
      return true;
    });

    renderReport(filtered);
  });

  function renderReport(data) {
    if(data.length === 0){
      reportTable.style.display = 'none';
      totalsDiv.textContent = 'Gösterilecek kayıt yok.';
      return;
    }

    reportTable.style.display = 'table';
    reportBody.innerHTML = '';

    // Tür+Kategori bazında topla
    const aggregated = {};
    data.forEach(e => {
      const key = e.type + '|' + e.category;
      if(!aggregated[key]) aggregated[key] = 0;
      aggregated[key] += e.amount;
    });

    let totalIncome = 0;
    let totalExpense = 0;

    for(const key in aggregated){
      const [type, category] = key.split('|');
      const amount = aggregated[key];

      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${type}</td><td>${category}</td><td>${amount.toFixed(2)}</td>`;
      reportBody.appendChild(tr);

      if(type === 'gelir') totalIncome += amount;
      else totalExpense += amount;
    }

    totalsDiv.textContent = `Toplam Gelir: ${totalIncome.toFixed(2)} ₺, Toplam Gider: ${totalExpense.toFixed(2)} ₺, Net: ${(totalIncome - totalExpense).toFixed(2)} ₺`;
  }

  exportPdfBtn.addEventListener('click', () => {
    if(entries.length === 0){
      alert('PDF oluşturmak için kayıt yok.');
      return;
    }
    const start = startDateInput.value;
    const end = endDateInput.value;

    const filtered = entries.filter(e => {
      if(start && e.date < start) return false;
      if(end && e.date > end) return false;
      return true;
    });

    if(filtered.length === 0){
      alert('Seçilen tarihlerde kayıt bulunamadı.');
      return;
    }

    const aggregated = {};
    filtered.forEach(e => {
      const key = e.type + '|' + e.category;
      if(!aggregated[key]) aggregated[key] = 0;
      aggregated[key] += e.amount;
    });

    let totalIncome = 0;
    let totalExpense = 0;

    const doc = new jsPDF();

    doc.setFontSize(18);
    doc.text("Gelir Gider Raporu", 14, 22);

    doc.setFontSize(12);
    doc.text(`Tarih Aralığı: ${start || 'Başlangıç'} - ${end || 'Bitiş'}`, 14, 30);

    // Tablo başlığı
    doc.text("Tür     Kategori     Tutar (₺)", 14, 40);

    let y = 50;
    for(const key in aggregated){
      const [type, category] = key.split('|');
      const amount = aggregated[key];

      doc.text(`${type}     ${category}     ${amount.toFixed(2)}`, 14, y);
      y += 10;

      if(type === 'gelir') totalIncome += amount;
      else totalExpense += amount;
    }

    y += 10;
    doc.text(`Toplam Gelir: ${totalIncome.toFixed(2)} ₺`, 14, y);
    y += 10;
    doc.text(`Toplam Gider: ${totalExpense.toFixed(2)} ₺`, 14, y);
    y += 10;
    doc.text(`Net Kar/Zarar: ${(totalIncome - totalExpense).toFixed(2)} ₺`, 14, y);

    doc.save(`GelirGiderRapor_${start || 'baslangic'}_${end || 'bitis'}.pdf`);
  });

  // İlk açılışta raporu boş göster
  renderReport(entries);

</script>

</body>
</html>
