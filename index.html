<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Gelir Gider Takip Sistemi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 10px;
    }
    h2 {
      text-align: center;
      color: #1976d2;
    }
    input, select, button, textarea {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px 0;
      font-size: 16px;
      box-sizing: border-box;
    }
    button {
      background-color: #1976d2;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 5px;
    }
    button:hover {
      background-color: #0d47a1;
    }
    #logout-btn {
      background-color: #c62828;
      margin-bottom: 20px;
    }
    #logout-btn:hover {
      background-color: #8e0000;
    }
    #message {
      font-weight: bold;
      margin-bottom: 20px;
      text-align: center;
    }
    #report {
      margin-top: 20px;
      border-top: 2px solid #1976d2;
      padding-top: 15px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #1976d2;
      padding: 8px;
      text-align: center;
    }
    #pdf-btn {
      margin-top: 15px;
      background-color: #388e3c;
    }
    #pdf-btn:hover {
      background-color: #27632a;
    }
  </style>
</head>
<body>

  <h2>Gelir Gider Takip Sistemi</h2>

  <!-- Giriş / Kayıt -->
  <div id="auth-section">
    <input type="email" id="email" placeholder="Email adresinizi girin" />
    <input type="password" id="password" placeholder="Şifrenizi girin" />
    <button id="register-btn">Kayıt Ol</button>
    <button id="login-btn">Giriş Yap</button>
  </div>

  <div id="message"></div>

  <!-- Ana uygulama -->
  <div id="app-section" style="display:none;">

    <button id="logout-btn">Çıkış Yap</button>

    <h3>Gelir / Gider Ekle</h3>

    <label for="type">Tür</label>
    <select id="type">
      <option value="gelir">Gelir</option>
      <option value="gider">Gider</option>
    </select>

    <label for="category">Kategori (manuel doldurun)</label>
    <input type="text" id="category" placeholder="Kategori girin" />

    <label for="subcategory">Alt Kategori (isteğe bağlı)</label>
    <input type="text" id="subcategory" placeholder="Alt kategori girin" />

    <label for="description">Açıklama / Not (isteğe bağlı)</label>
    <textarea id="description" placeholder="Açıklama girin" rows="2"></textarea>

    <label for="amount">Tutar (₺)</label>
    <input type="number" id="amount" min="0" step="0.01" placeholder="Örn: 100.50" />

    <label for="date">Tarih</label>
    <input type="date" id="date" />

    <button id="add-entry-btn">Ekle</button>

    <div id="report">

      <h3>Raporlama</h3>

      <label for="filter-start">Başlangıç Tarihi</label>
      <input type="date" id="filter-start" />

      <label for="filter-end">Bitiş Tarihi</label>
      <input type="date" id="filter-end" />

      <button id="filter-btn">Filtrele</button>
      <button id="pdf-btn">PDF Olarak İndir</button>

      <div id="totals" style="margin-top: 15px; font-weight: bold;"></div>

      <table id="entries-table" style="display:none;">
        <thead>
          <tr>
            <th>Tarih</th>
            <th>Tür</th>
            <th>Kategori</th>
            <th>Alt Kategori</th>
            <th>Açıklama</th>
            <th>Tutar (₺)</th>
          </tr>
        </thead>
        <tbody id="entries-tbody"></tbody>
      </table>

    </div>

  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <script>
    // Firebase config - kendi bilgilerinle değiştir
    const firebaseConfig = {
      apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
      authDomain: "gelir-gider-d3dc3.firebaseapp.com",
      projectId: "gelir-gider-d3dc3",
      storageBucket: "gelir-gider-d3dc3.appspot.com",
      messagingSenderId: "791363419549",
      appId: "1:791363419549:web:724a349a5efcd6b7c30374",
      measurementId: "G-B8NKY7SR14"
    };

    // Firebase başlat
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Elementler
    const authSection = document.getElementById('auth-section');
    const appSection = document.getElementById('app-section');
    const messageDiv = document.getElementById('message');

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');

    const registerBtn = document.getElementById('register-btn');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');

    const typeSelect = document.getElementById('type');
    const categoryInput = document.getElementById('category');
    const subcategoryInput = document.getElementById('subcategory');
    const descriptionInput = document.getElementById('description');
    const amountInput = document.getElementById('amount');
    const dateInput = document.getElementById('date');

    const addEntryBtn = document.getElementById('add-entry-btn');

    const filterStart = document.getElementById('filter-start');
    const filterEnd = document.getElementById('filter-end');
    const filterBtn = document.getElementById('filter-btn');

    const entriesTable = document.getElementById('entries-table');
    const entriesTbody = document.getElementById('entries-tbody');
    const totalsDiv = document.getElementById('totals');

    const pdfBtn = document.getElementById('pdf-btn');

    // Mesaj gösterme fonksiyonu
    function showMessage(text, isError = false) {
      messageDiv.textContent = text;
      messageDiv.style.color = isError ? 'red' : 'green';
    }

    // Kullanıcı durumuna göre görünüm ayarı
    auth.onAuthStateChanged(user => {
      if (user) {
        authSection.style.display = 'none';
        appSection.style.display = 'block';
        showMessage(`Hoş geldiniz, ${user.email}`);

        if (!dateInput.value) {
          dateInput.value = new Date().toISOString().substring(0,10);
        }

        loadEntries();
      } else {
        authSection.style.display = 'block';
        appSection.style.display = 'none';
        showMessage('');
      }
    });

    // Kayıt ol
    registerBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        showMessage('Email ve şifre boş bırakılamaz.', true);
        return;
      }

      auth.createUserWithEmailAndPassword(email, password)
        .then(() => showMessage('Kayıt başarılı! Giriş yapabilirsiniz.'))
        .catch(err => showMessage(err.message, true));
    });

    // Giriş yap
    loginBtn.addEventListener('click', () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if (!email || !password) {
        showMessage('Email ve şifre boş bırakılamaz.', true);
        return;
      }

      auth.signInWithEmailAndPassword(email, password)
        .then(() => showMessage('Giriş başarılı!'))
        .catch(err => showMessage(err.message, true));
    });

    // Çıkış yap
    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    // Veri ekleme
    addEntryBtn.addEventListener('click', () => {
      const user = auth.currentUser;
      if (!user) {
        showMessage('Giriş yapmalısınız.', true);
        return;
      }

      const type = typeSelect.value;
      const category = categoryInput.value.trim();
      const subcategory = subcategoryInput.value.trim();
      const description = descriptionInput.value.trim();
      const amount = parseFloat(amountInput.value);
      const date = dateInput.value;

      if (!category) {
        showMessage('Kategori boş olamaz.', true);
        return;
      }
      if (isNaN(amount) || amount <= 0) {
        showMessage('Geçerli bir tutar girin.', true);
        return;
      }
      if (!date) {
        showMessage('Tarih seçmelisiniz.', true);
        return;
      }

      // Firestore'a kaydet
      db.collection('entries').add({
        uid: user.uid,
        type,
        category,
        subcategory,
        description,
        amount,
        date,
        timestamp: firebase.firestore.Timestamp.fromDate(new Date(date))
      })
      .then(() => {
        showMessage('İşlem eklendi.');
        // Alanları temizle
        categoryInput.value = '';
        subcategoryInput.value = '';
        descriptionInput.value = '';
        amountInput.value = '';
        dateInput.value = new Date().toISOString().substring(0,10);

        loadEntries(); // Listeyi yenile
      })
      .catch(err => {
        showMessage('Hata: ' + err.message, true);
      });
    });

    // Kayıtları çekip tabloyu oluşturma
    function loadEntries(filterStartDate = null, filterEndDate = null) {
      const user = auth.currentUser;
      if (!user) return;

      let query = db.collection('entries').where('uid', '==', user.uid).orderBy('timestamp', 'desc');

      if (filterStartDate) {
        query = query.where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(new Date(filterStartDate)));
      }
      if (filterEndDate) {
        // Gün sonu için 23:59:59 ekle
        const endDateObj = new Date(filterEndDate);
        endDateObj.setHours(23, 59, 59);
        query = query.where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(endDateObj));
      }

      query.get().then(snapshot => {
        const entries = [];
        snapshot.forEach(doc => {
          entries.push(doc.data());
        });
        displayEntries(entries);
      });
    }

    // Verileri tabloya ve toplam rapora yazma
    function displayEntries(entries) {
      if (entries.length === 0) {
        entriesTable.style.display = 'none';
        totalsDiv.textContent = 'Kayıt bulunamadı.';
        return;
      }

      entriesTable.style.display = 'table';
      entriesTbody.innerHTML = '';

      let totalIncome = 0;
      let totalExpense = 0;

      // Raporlama için kategorileri alt kategorilere göre gruplayıp toplayabiliriz:
      // Ama şimdilik sadece toplam tutarları hesaplıyoruz.

      entries.forEach(entry => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.type === 'gelir' ? 'Gelir' : 'Gider'}</td>
          <td>${entry.category}</td>
          <td>${entry.subcategory || '-'}</td>
          <td>${entry.description || '-'}</td>
          <td>${entry.amount.toFixed(2)}</td>
        `;

        entriesTbody.appendChild(tr);

        if (entry.type === 'gelir') totalIncome += entry.amount;
        else totalExpense += entry.amount;
      });

      const net = totalIncome - totalExpense;

      totalsDiv.textContent = `Toplam Gelir: ₺${totalIncome.toFixed(2)} | Toplam Gider: ₺${totalExpense.toFixed(2)} | Net Kar/Zarar: ₺${net.toFixed(2)}`;
    }

    // Filtrele butonu
    filterBtn.addEventListener('click', () => {
      const start = filterStart.value || null;
      const end = filterEnd.value || null;
      loadEntries(start, end);
    });

    // PDF oluşturma (jsPDF ile)
    pdfBtn.addEventListener('click', () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      doc.setFontSize(16);
      doc.text("Gelir Gider Raporu", 14, 20);

      const totalText = totalsDiv.textContent;
      doc.setFontSize(12);
      doc.text(totalText, 14, 30);

      // Tablo başlıkları
      const head = [['Tarih', 'Tür', 'Kategori', 'Alt Kategori', 'Açıklama', 'Tutar (₺)']];

      // Tablo içeriği
      const body = [];
      const rows = entriesTbody.querySelectorAll('tr');
      rows.forEach(row => {
        const cols = row.querySelectorAll('td');
        const rowData = [];
        cols.forEach(col => rowData.push(col.textContent));
        body.push(rowData);
      });

      doc.autoTable({
        startY: 40,
        head: head,
        body: body,
        styles: { fontSize: 10 },
      });

      doc.save('gelir-gider-raporu.pdf');
    });
  </script>

</body>
</html>
