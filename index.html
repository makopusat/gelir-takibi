<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gelir Gider Takip - Firebase Auth + Alt Kategori Seçimi</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f0f2f5; }
  header { background: #4a90e2; color: white; padding: 1rem; text-align: center; }
  main { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px #ccc;}
  h2 { margin-top: 0; }
  label { display: block; margin: 10px 0 5px; font-weight: bold; }
  input[type=text], input[type=number], input[type=date], select {
    width: 100%; padding: 8px; box-sizing: border-box; border-radius: 4px; border: 1px solid #ccc;
  }
  button {
    width: 100%; padding: 12px; margin: 15px 0;
    background-color: #4a90e2; border: none; border-radius: 6px;
    color: white; font-weight: bold; font-size: 1.1rem;
    cursor: pointer;
  }
  button:hover { background-color: #357abd; }
  .hidden { display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px;}
  th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
  th { background-color: #4a90e2; color: white; }
  #totals { margin-top: 15px; font-weight: bold; font-size: 1.1rem; }
  .message { padding: 10px; background-color: #d4edda; color: #155724; margin-bottom: 15px; border-radius: 5px; display:none; }
  .error { background-color: #f8d7da; color: #721c24; }
</style>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
    authDomain: "gelir-gider-d3dc3.firebaseapp.com",
    projectId: "gelir-gider-d3dc3",
    storageBucket: "gelir-gider-d3dc3.appspot.com",
    messagingSenderId: "791363419549",
    appId: "1:791363419549:web:724a349a5efcd6b7c30374"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // DOM Elements
  const loginSection = document.getElementById('loginSection');
  const appSection = document.getElementById('appSection');
  const messageDiv = document.getElementById('message');
  const errorDiv = document.getElementById('errorMessage');

  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');
  const btnLogout = document.getElementById('btnLogout');

  const typeSelect = document.getElementById('type');
  const categorySelect = document.getElementById('categorySelect');
  const addCategoryInput = document.getElementById('addCategoryInput');
  const addCategoryBtn = document.getElementById('addCategoryBtn');

  const subcategorySelect = document.getElementById('subcategorySelect');
  const addSubcategoryInput = document.getElementById('addSubcategoryInput');
  const addSubcategoryBtn = document.getElementById('addSubcategoryBtn');

  const amountInput = document.getElementById('amount');
  const descriptionInput = document.getElementById('description');
  const dateInput = document.getElementById('date');
  const addEntryBtn = document.getElementById('addEntryBtn');

  const entriesTable = document.getElementById('entriesTable');
  const entriesTbody = document.getElementById('entriesTbody');
  const totalsDiv = document.getElementById('totals');

  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const filterBtn = document.getElementById('filterBtn');

  // Veri yapıları
  let categories = ['Maaş', 'Kira', 'Market', 'Elektrik'];
  let selectedCategories = new Set();

  // Alt kategoriler obje şeklinde kategori bazında saklanacak
  // { 'Maaş': ['Bonus', 'Aylık'], 'Kira': ['Ev', 'İşyeri'] }
  let subcategoriesByCategory = {
    'Maaş': ['Bonus', 'Aylık'],
    'Kira': ['Ev', 'İşyeri'],
    'Market': [],
    'Elektrik': []
  };

  let entries = [];

  function showMessage(text) {
    messageDiv.textContent = text;
    messageDiv.style.display = 'block';
    errorDiv.style.display = 'none';
    setTimeout(() => { messageDiv.style.display = 'none'; }, 3000);
  }

  function showError(text) {
    errorDiv.textContent = text;
    errorDiv.style.display = 'block';
    messageDiv.style.display = 'none';
    setTimeout(() => { errorDiv.style.display = 'none'; }, 4000);
  }

  // Kategori dropdown yenile
  function loadCategories() {
    categorySelect.innerHTML = '<option value="">Seçiniz...</option>';
    categories.forEach(cat => {
      if (!selectedCategories.has(cat)) {
        const opt = document.createElement('option');
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      }
    });
  }

  // Alt kategori dropdown yenile (seçili kategoriye göre)
  function loadSubcategories(cat) {
    subcategorySelect.innerHTML = '<option value="">(Alt kategori seçiniz veya yeni ekleyin)</option>';
    if (!cat || !subcategoriesByCategory[cat]) return;
    subcategoriesByCategory[cat].forEach(sub => {
      const opt = document.createElement('option');
      opt.value = sub;
      opt.textContent = sub;
      subcategorySelect.appendChild(opt);
    });
  }

  // Seçilen kategoriyi set’e ekle, dropdown’dan çıkar
  function addSelectedCategory(cat) {
    selectedCategories.add(cat);
    loadCategories();
  }

  function removeSelectedCategory(cat) {
    selectedCategories.delete(cat);
    loadCategories();
  }

  // Tarih aralığında kontrol
  function isDateBetween(date, start, end) {
    if (!start && !end) return true;
    const d = new Date(date);
    if (start && d < new Date(start)) return false;
    if (end && d > new Date(end)) return false;
    return true;
  }

  // Raporlama
  function displayEntries(filteredEntries) {
    if (filteredEntries.length === 0) {
      entriesTable.style.display = 'none';
      totalsDiv.textContent = 'Kayıt bulunamadı.';
      return;
    }

    // Grup: tür|kategori|altkategori
    const grouped = {};

    filteredEntries.forEach(entry => {
      const sub = entry.subcategory || '-';
      const key = `${entry.type}|${entry.category}|${sub}`;

      if (!grouped[key]) {
        grouped[key] = {
          type: entry.type,
          category: entry.category,
          subcategory: sub,
          amount: 0
        };
      }
      grouped[key].amount += entry.amount;
    });

    entriesTable.style.display = 'table';
    entriesTbody.innerHTML = '';

    let totalIncome = 0;
    let totalExpense = 0;

    Object.values(grouped).forEach(entry => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${entry.type === 'gelir' ? 'Gelir' : 'Gider'}</td>
        <td>${entry.category}</td>
        <td>${entry.subcategory}</td>
        <td>${entry.amount.toFixed(2)}</td>
      `;
      entriesTbody.appendChild(tr);

      if (entry.type === 'gelir') totalIncome += entry.amount;
      else totalExpense += entry.amount;
    });

    totalsDiv.textContent = `Toplam Gelir: ${totalIncome.toFixed(2)} ₺, Toplam Gider: ${totalExpense.toFixed(2)} ₺, Net Kar/Zarar: ${(totalIncome - totalExpense).toFixed(2)} ₺`;
  }

  // Yeni kategori ekle (manuel)
  addCategoryBtn.addEventListener('click', () => {
    const newCat = addCategoryInput.value.trim();
    if (!newCat) {
      showError('Kategori adı boş olamaz!');
      return;
    }
    if (categories.includes(newCat)) {
      showError('Bu kategori zaten mevcut!');
      return;
    }
    categories.push(newCat);
    subcategoriesByCategory[newCat] = [];
    loadCategories();
    addCategoryInput.value = '';
    showMessage('Kategori eklendi.');
  });

  // Yeni alt kategori ekle (manuel, seçili kategoriye)
  addSubcategoryBtn.addEventListener('click', () => {
    const newSub = addSubcategoryInput.value.trim();
    const selectedCat = categorySelect.value;
    if (!selectedCat) {
      showError('Lütfen önce kategori seçin!');
      return;
    }
    if (!newSub) {
      showError('Alt kategori boş olamaz!');
      return;
    }
    if (!subcategoriesByCategory[selectedCat]) {
      subcategoriesByCategory[selectedCat] = [];
    }
    if (subcategoriesByCategory[selectedCat].includes(newSub)) {
      showError('Bu alt kategori zaten mevcut!');
      return;
    }
    subcategoriesByCategory[selectedCat].push(newSub);
    loadSubcategories(selectedCat);
    addSubcategoryInput.value = '';
    showMessage('Alt kategori eklendi.');
  });

  // Kategori seçimi değişince alt kategorileri yenile
  categorySelect.addEventListener('change', (e) => {
    loadSubcategories(e.target.value);
  });

  // Giriş ekle
  addEntryBtn.addEventListener('click', () => {
    const type = typeSelect.value;
    const category = categorySelect.value;
    const subcategory = subcategorySelect.value || '';
    const amount = parseFloat(amountInput.value);
    const description = descriptionInput.value.trim();
    const date = dateInput.value;

    if (!type) {
      showError('Lütfen gelir veya gider seçin.');
      return;
    }
    if (!category) {
      showError('Lütfen kategori seçin.');
      return;
    }
    if (!amount || amount <= 0) {
      showError('Lütfen geçerli bir tutar girin.');
      return;
    }
    if (!date) {
      showError('Lütfen tarih seçin.');
      return;
    }

    entries.push({ type, category, subcategory, amount, description, date });
    showMessage('Kayıt eklendi.');

    // Alanları temizle
    amountInput.value = '';
    descriptionInput.value = '';
    dateInput.value = '';

    // Filtreye göre göster
    applyFilter();
  });

  // Filtrele ve göster
  function applyFilter() {
    const start = startDateInput.value;
    const end = endDateInput.value;
    const filtered = entries.filter(e => isDateBetween(e.date, start, end));
    displayEntries(filtered);
  }

  filterBtn.addEventListener('click', applyFilter);

  // Firebase Auth işlemleri

  btnLogin.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      showError('Email ve şifre boş olamaz!');
      return;
    }
    signInWithEmailAndPassword(auth, email, password)
      .then(() => {
        showMessage('Giriş başarılı!');
      })
      .catch(err => showError('Giriş başarısız: ' + err.message));
  });

  btnRegister.addEventListener('click', () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    if (!email || !password) {
      showError('Email ve şifre boş olamaz!');
      return;
    }
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => showMessage('Kayıt başarılı! Giriş yapabilirsiniz.'))
      .catch(err => showError('Kayıt başarısız: ' + err.message));
  });

  btnLogout.addEventListener('click', () => {
    signOut(auth).then(() => {
      showMessage('Çıkış yapıldı.');
    });
  });

  // Oturum durumu kontrolü
  onAuthStateChanged(auth, user => {
    if (user) {
      loginSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      loadCategories();
      applyFilter();
    } else {
      loginSection.classList.remove('hidden');
      appSection.classList.add('hidden');
    }
  });

  // Sayfa yüklendiğinde tarih default
  window.onload = () => {
    const today = new Date().toISOString().substring(0, 10);
    dateInput.value = today;
    startDateInput.value = '';
    endDateInput.value = '';
  }
</script>
</head>
<body>

<header>
  <h1>Gelir Gider Takip Sistemi</h1>
</header>

<section id="loginSection">
  <h2>Giriş / Kayıt</h2>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Şifre" />
  <button id="btnLogin">Giriş Yap</button>
  <button id="btnRegister">Kayıt Ol</button>
  <div id="message" class="message"></div>
  <div id="errorMessage" class="message error"></div>
</section>

<section id="appSection" class="hidden">
  <button id="btnLogout" style="float:right; margin-bottom: 10px;">Çıkış Yap</button>

  <h2>Gelir/Gider Kaydı Ekle</h2>
  <label for="type">Tür:</label>
  <select id="type">
    <option value="">Seçiniz...</option>
    <option value="gelir">Gelir</option>
    <option value="gider">Gider</option>
  </select>

  <label for="categorySelect">Kategori Seç:</label>
  <select id="categorySelect"></select>

  <label for="addCategoryInput">Yeni Kategori Ekle (manuel):</label>
  <input type="text" id="addCategoryInput" placeholder="Yeni kategori adı" />
  <button id="addCategoryBtn">Kategori Ekle</button>

  <label for="subcategorySelect">Alt Kategori Seç:</label>
  <select id="subcategorySelect"></select>

  <label for="addSubcategoryInput">Yeni Alt Kategori Ekle (manuel, seçili kategoriye):</label>
  <input type="text" id="addSubcategoryInput" placeholder="Yeni alt kategori adı" />
  <button id="addSubcategoryBtn">Alt Kategori Ekle</button>

  <label for="amount">Tutar (₺):</label>
  <input type="number" id="amount" min="0.01" step="0.01" />

  <label for="description">Açıklama (opsiyonel):</label>
  <input type="text" id="description" />

  <label for="date">Tarih:</label>
  <input type="date" id="date" />

  <button id="addEntryBtn">Kayıt Ekle</button>

  <h2>Raporlama</h2>
  <label for="startDate">Başlangıç Tarihi:</label>
  <input type="date" id="startDate" />
  <label for="endDate">Bitiş Tarihi:</label>
  <input type="date" id="endDate" />
  <button id="filterBtn">Filtrele</button>

  <table id="entriesTable" style="display:none;">
    <thead>
      <tr>
        <th>Tür</th>
        <th>Kategori</th>
        <th>Alt Kategori</th>
        <th>Tutar (₺)</th>
      </tr>
    </thead>
    <tbody id="entriesTbody"></tbody>
  </table>
  <div id="totals"></div>
</section>

</body>
</html>
