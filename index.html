<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Gelir/Gider Takip Sistemi</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;
      background: #f9f9f9;
      color: #222;
    }
    h2, h3 {
      text-align: center;
    }
    label {
      display: block;
      margin: 8px 0 4px;
    }
    select, input[type="text"], input[type="number"], input[type="date"], input[type="email"], input[type="password"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      margin-top: 12px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 6px;
      background: #1976d2;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    button:hover {
      background-color: #155a9c;
    }
    button.delete {
      background: #d32f2f;
    }
    button.delete:hover {
      background: #9a2222;
    }
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 10px;
      box-shadow: 0 0 6px rgba(0,0,0,0.1);
    }
    select[size="8"] {
      height: 180px;
    }
    #filtered-report ul {
      list-style-type: none;
      padding-left: 0;
    }
    #filtered-report ul li {
      background: #e3f2fd;
      margin: 4px 0;
      padding: 6px 10px;
      border-radius: 4px;
    }
    .hidden {
      display: none;
    }
    #message {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: #d32f2f;
    }
  </style>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <h2>Gelir/Gider Takip Sistemi</h2>
  
  <div id="message"></div>

  <!-- Kayıt/Giriş Bölümü -->
  <div id="auth-section" class="section">
    <h3>Kullanıcı Girişi / Kayıt</h3>
    <input type="email" id="email" placeholder="E-posta" />
    <input type="password" id="password" placeholder="Şifre" />
    <button id="registerBtn">Kayıt Ol</button>
    <button id="loginBtn">Giriş Yap</button>
  </div>

  <!-- Ana Uygulama Bölümü -->
  <div id="app-section" class="section hidden">

    <button id="logoutBtn" style="background:#d32f2f; margin-bottom: 15px;">Çıkış Yap</button>

    <form id="transactionForm">
      <label for="type">Tür:</label>
      <select id="type" required>
        <option value="Gelir">Gelir</option>
        <option value="Gider">Gider</option>
      </select>

      <label for="subcategory">Alt Kategori:</label>
      <select id="subcategory" required>
        <!-- Başta boş, kullanıcı ekleyecek -->
      </select>
      <input type="text" id="newSubcategory" placeholder="Yeni Alt Kategori Ekle" />
      <button type="button" id="addSubcategoryBtn">Alt Kategori Ekle</button>

      <label for="amount">Tutar:</label>
      <input type="number" id="amount" step="0.01" min="0" required />

      <label for="description">Açıklama:</label>
      <input type="text" id="description" required />

      <label for="date">Tarih:</label>
      <input type="date" id="date" required />

      <button type="submit" id="addBtn">Ekle</button>
      <button type="button" id="editBtn" class="hidden">Kaydet</button>
    </form>

    <h3>İşlem Listesi</h3>
    <select id="transactionList" size="8" style="width: 100%;"></select>
    <button id="editSelectedBtn">Düzenle</button>
    <button id="deleteSelectedBtn" class="delete">Sil</button>

    <h4>Toplam Gelir: <span id="totalIncome">0</span> TL</h4>
    <h4>Toplam Gider: <span id="totalExpense">0</span> TL</h4>
    <h4>Toplam Kar: <span id="totalProfit">0</span> TL</h4>

    <div class="section" style="margin-top: 30px;">
      <h3>Raporlama</h3>
      <label for="startDate">Başlangıç Tarihi:</label>
      <input type="date" id="startDate" />
      <label for="endDate">Bitiş Tarihi:</label>
      <input type="date" id="endDate" />
      <button id="filterBtn">Raporla</button>
      <button id="printBtn">PDF Olarak Kaydet / Yazdır</button>

      <div id="filtered-report" style="margin-top: 15px;"></div>
    </div>
  </div>

<script>
  // Firebase yapılandırması
  const firebaseConfig = {
    apiKey: "AIzaSyCTZXqmpVQeYwm2PoDwEYih9vDDl3A5rtI",
    authDomain: "gelir-gider-d3dc3.firebaseapp.com",
    projectId: "gelir-gider-d3dc3",
    storageBucket: "gelir-gider-d3dc3.firebasestorage.app",
    messagingSenderId: "791363419549",
    appId: "1:791363419549:web:724a349a5efcd6b7c30374",
    measurementId: "G-B8NKY7SR14"
  };

  // Firebase başlat
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  // HTML elementleri
  const messageEl = document.getElementById("message");
  const authSection = document.getElementById("auth-section");
  const appSection = document.getElementById("app-section");

  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const registerBtn = document.getElementById("registerBtn");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const typeEl = document.getElementById("type");
  const subcategoryEl = document.getElementById("subcategory");
  const newSubcategoryInput = document.getElementById("newSubcategory");
  const addSubcategoryBtn = document.getElementById("addSubcategoryBtn");

  const amountInput = document.getElementById("amount");
  const descriptionInput = document.getElementById("description");
  const dateInput = document.getElementById("date");

  const transactionForm = document.getElementById("transactionForm");
  const transactionList = document.getElementById("transactionList");
  const editSelectedBtn = document.getElementById("editSelectedBtn");
  const deleteSelectedBtn = document.getElementById("deleteSelectedBtn");
  const addBtn = document.getElementById("addBtn");
  const editBtn = document.getElementById("editBtn");

  const totalIncomeEl = document.getElementById("totalIncome");
  const totalExpenseEl = document.getElementById("totalExpense");
  const totalProfitEl = document.getElementById("totalProfit");

  const startDateEl = document.getElementById("startDate");
  const endDateEl = document.getElementById("endDate");
  const filterBtn = document.getElementById("filterBtn");
  const printBtn = document.getElementById("printBtn");
  const filteredReportEl = document.getElementById("filtered-report");

  // Durum
  let transactions = [];
  let subcategories = { Gelir: [], Gider: [] };
  let selectedIndex = null;
  let currentUser = null;

  // Kullanıcı Girişi / Kaydı
  registerBtn.onclick = () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    if(!email || !pass) {
      showMessage("E-posta ve şifre gerekli.");
      return;
    }
    auth.createUserWithEmailAndPassword(email, pass)
      .then(() => {
        showMessage("Kayıt başarılı, giriş yapabilirsiniz.", "green");
      })
      .catch(err => {
        showMessage("Kayıt hatası: " + err.message);
      });
  };

  loginBtn.onclick = () => {
    const email = emailInput.value.trim();
    const pass = passwordInput.value;
    if(!email || !pass) {
      showMessage("E-posta ve şifre gerekli.");
      return;
    }
    auth.signInWithEmailAndPassword(email, pass)
      .then((userCredential) => {
        currentUser = userCredential.user;
        showMessage(`Hoşgeldiniz, ${currentUser.email}`, "green");
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        loadData();
      })
      .catch(err => {
        showMessage("Giriş hatası: " + err.message);
      });
  };

  logoutBtn.onclick = () => {
    auth.signOut().then(() => {
      currentUser = null;
      showMessage("Çıkış yapıldı.", "green");
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      clearForm();
      transactions = [];
      subcategories = { Gelir: [], Gider: [] };
      renderTransactions();
      renderSubcategories();
      clearReport();
    });
  };

  // Mesaj göster
  function showMessage(text, color = "red") {
    messageEl.style.color = color;
    messageEl.textContent = text;
    setTimeout(() => messageEl.textContent = "", 4000);
  }

  // Veri yükle
  function loadData() {
    if (!currentUser) return;

    // Kullanıcının alt kategorilerini getir
    db.collection("users").doc(currentUser.uid).collection("subcategories").get()
      .then(snapshot => {
        subcategories = { Gelir: [], Gider: [] };
        snapshot.forEach(doc => {
          const data = doc.data();
          if (data.type && data.name) {
            subcategories[data.type].push(data.name);
          }
        });
        renderSubcategories();
      });

    // İşlemleri getir
    db.collection("users").doc(currentUser.uid).collection("transactions")
      .orderBy("date", "desc")
      .get()
      .then(snapshot => {
        transactions = [];
        snapshot.forEach(doc => {
          const d = doc.data();
          transactions.push({
            id: doc.id,
            type: d.type,
            subcategory: d.subcategory,
            amount: d.amount,
            description: d.description,
            date: d.date
          });
        });
        renderTransactions();
        calculateTotals();
        clearReport();
      });
  }

  // Alt kategorileri renderla
  function renderSubcategories() {
    // Seçim listesini temizle
    subcategoryEl.innerHTML = "";

    // Seçilen tipe göre liste oluştur
    const tip = typeEl.value;
    if(subcategories[tip]) {
      if(subcategories[tip].length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Henüz alt kategori yok";
        subcategoryEl.appendChild(opt);
      } else {
        subcategories[tip].forEach(sc => {
          const opt = document.createElement("option");
          opt.value = sc;
          opt.textContent = sc;
          subcategoryEl.appendChild(opt);
        });
      }
    }
  }

  typeEl.addEventListener("change", renderSubcategories);

  // Yeni alt kategori ekle
  addSubcategoryBtn.onclick = () => {
    const tip = typeEl.value;
    const yeniAlt = newSubcategoryInput.value.trim();
    if (!yeniAlt) {
      alert("Alt kategori adı boş olamaz!");
      return;
    }
    if (subcategories[tip].includes(yeniAlt)) {
      alert("Bu alt kategori zaten var.");
      return;
    }
    // Firestore'a ekle
    db.collection("users").doc(currentUser.uid).collection("subcategories")
      .add({ type: tip, name: yeniAlt })
      .then(() => {
        subcategories[tip].push(yeniAlt);
        renderSubcategories();
        newSubcategoryInput.value = "";
      });
  };

  // Formu temizle
  function clearForm() {
    transactionForm.reset();
    editBtn.classList.add("hidden");
    addBtn.classList.remove("hidden");
    selectedIndex = null;
  }

  // İşlem ekle
  transactionForm.addEventListener("submit", e => {
    e.preventDefault();
    if (!currentUser) {
      alert("Lütfen giriş yapınız.");
      return;
    }

    const tip = typeEl.value;
    const alt = subcategoryEl.value;
    const tutar = parseFloat(amountInput.value);
    const aciklama = descriptionInput.value.trim();
    const tarih = dateInput.value;

    if (!alt) {
      alert("Lütfen alt kategori seçin.");
      return;
    }
    if (!tarih) {
      alert("Lütfen tarih seçin.");
      return;
    }
    if (isNaN(tutar) || tutar <= 0) {
      alert("Geçerli bir tutar girin.");
      return;
    }
    if (!aciklama) {
      alert("Açıklama boş olamaz.");
      return;
    }

    const newTransaction = {
      type: tip,
      subcategory: alt,
      amount: tutar,
      description: aciklama,
      date: tarih
    };

    if (selectedIndex === null) {
      // Yeni ekle
      db.collection("users").doc(currentUser.uid).collection("transactions")
        .add(newTransaction)
        .then(() => {
          loadData();
          clearForm();
        });
    } else {
      // Düzenle
      const id = transactions[selectedIndex].id;
      db.collection("users").doc(currentUser.uid).collection("transactions").doc(id)
        .set(newTransaction)
        .then(() => {
          loadData();
          clearForm();
        });
    }
  });

  // İşlemleri listele
  function renderTransactions() {
    transactionList.innerHTML = "";
    transactions.forEach((tx, i) => {
      const opt = document.createElement("option");
      opt.value = i;
      opt.textContent = `${tx.date} - ${tx.type} - ${tx.subcategory} - ${tx.amount.toFixed(2)} TL - ${tx.description}`;
      transactionList.appendChild(opt);
    });
  }

  // Liste elemanını seç
  transactionList.addEventListener("change", () => {
    selectedIndex = parseInt(transactionList.value);
  });

  // Düzenleme butonu
  editSelectedBtn.onclick = () => {
    if (selectedIndex === null) {
      alert("Önce bir işlem seçin.");
      return;
    }
    const tx = transactions[selectedIndex];
    typeEl.value = tx.type;
    renderSubcategories();
    subcategoryEl.value = tx.subcategory;
    amountInput.value = tx.amount;
    descriptionInput.value = tx.description;
    dateInput.value = tx.date;

    addBtn.classList.add("hidden");
    editBtn.classList.remove("hidden");
  };

  // Silme butonu
  deleteSelectedBtn.onclick = () => {
    if (selectedIndex === null) {
      alert("Önce bir işlem seçin.");
      return;
    }
    if (!confirm("Seçilen işlemi silmek istediğinize emin misiniz?")) return;
    const id = transactions[selectedIndex].id;
    db.collection("users").doc(currentUser.uid).collection("transactions").doc(id)
      .delete()
      .then(() => {
        loadData();
        clearForm();
      });
  };

  // Düzenlemeyi kaydet
  editBtn.onclick = () => {
    transactionForm.dispatchEvent(new Event('submit'));
  };

  // Toplamları hesapla ve göster
  function calculateTotals() {
    const totalIncome = transactions
      .filter(t => t.type === "Gelir")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = transactions
      .filter(t => t.type === "Gider")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalProfit = totalIncome - totalExpense;

    totalIncomeEl.textContent = totalIncome.toFixed(2);
    totalExpenseEl.textContent = totalExpense.toFixed(2);
    totalProfitEl.textContent = totalProfit.toFixed(2);
  }

  // Filtreye göre raporu güncelle
  function updateFilteredReport() {
    const startDate = startDateEl.value ? new Date(startDateEl.value) : null;
    const endDate = endDateEl.value ? new Date(endDateEl.value) : null;

    const filtered = transactions.filter(tx => {
      const txDate = new Date(tx.date);
      if (startDate && txDate < startDate) return false;
      if (endDate && txDate > endDate) return false;
      return true;
    });

    // Alt kategori bazında grupla
    const grouped = { Gelir: {}, Gider: {} };
    filtered.forEach(tx => {
      if (!grouped[tx.type][tx.subcategory]) {
        grouped[tx.type][tx.subcategory] = 0;
      }
      grouped[tx.type][tx.subcategory] += tx.amount;
    });

    filteredReportEl.innerHTML = "";

    // Gelir alt kategorileri
    const gelirHeader = document.createElement("h4");
    gelirHeader.textContent = "Gelir Alt Kategorileri";
    filteredReportEl.appendChild(gelirHeader);
    const gelirList = document.createElement("ul");
    for (const [subcat, amount] of Object.entries(grouped.Gelir)) {
      const li = document.createElement("li");
      li.textContent = `${subcat}: ${amount.toFixed(2)} TL`;
      gelirList.appendChild(li);
    }
    filteredReportEl.appendChild(gelirList);

    // Gider alt kategorileri
    const giderHeader = document.createElement("h4");
    giderHeader.textContent = "Gider Alt Kategorileri";
    filteredReportEl.appendChild(giderHeader);
    const giderList = document.createElement("ul");
    for (const [subcat, amount] of Object.entries(grouped.Gider)) {
      const li = document.createElement("li");
      li.textContent = `${subcat}: ${amount.toFixed(2)} TL`;
      giderList.appendChild(li);
    }
    filteredReportEl.appendChild(giderList);

    // Toplamlar
    const totalIncome = filtered
      .filter(t => t.type === "Gelir")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalExpense = filtered
      .filter(t => t.type === "Gider")
      .reduce((sum, t) => sum + t.amount, 0);
    const totalProfit = totalIncome - totalExpense;

    const totalsP = document.createElement("p");
    totalsP.innerHTML = `<strong>Toplam Gelir:</strong> ${totalIncome.toFixed(2)} TL<br>
                         <strong>Toplam Gider:</strong> ${totalExpense.toFixed(2)} TL<br>
                         <strong>Net Kar:</strong> ${totalProfit.toFixed(2)} TL`;
    filteredReportEl.appendChild(totalsP);
  }

  filterBtn.onclick = () => {
    updateFilteredReport();
  };

  // PDF / Yazdırma işlemi
  printBtn.onclick = () => {
    const printContents = `
      <h2>Gelir/Gider Raporu</h2>
      <p><strong>Filtre Tarihleri:</strong> ${startDateEl.value || "Başlangıç Yok"} - ${endDateEl.value || "Bitiş Yok"}</p>
      ${filteredReportEl.innerHTML}
    `;
    const newWin = window.open("");
    newWin.document.write(`<html><head><title>Rapor</title></head><body>${printContents}</body></html>`);
    newWin.document.close();
    newWin.focus();
    newWin.print();
    newWin.close();
  };

  // Kullanıcı değiştiğinde yükle veya temizle
  auth.onAuthStateChanged(user => {
    if(user) {
      currentUser = user;
      authSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      loadData();
    } else {
      currentUser = null;
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      clearForm();
      transactions = [];
      subcategories = { Gelir: [], Gider: [] };
      renderTransactions();
      renderSubcategories();
      clearReport();
    }
  });
});
</script>

</body>
</html>
